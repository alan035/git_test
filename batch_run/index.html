<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>About - Awesome-tools</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../css/theme.css" />
  <link rel="stylesheet" href="../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "About";
    var mkdocs_page_input_path = "batch_run.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Awesome-tools</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                    </li>
                </ul>
                <ul class="current">
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">About</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#configjson">配置文件(config.json)</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#main_processlog">运行日志(main_process.log)</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#_1">支持的子命令</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#1-get_cmds">1. get_cmds子命令 (获取所有静态参数)</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#2-train">2. train子命令（批训练、负载测试以及重训练）</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#3-kill">3. kill子命令 (终止批训练或负载测试)</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#4-get_results">4. get_results子命令 (获取所有训练结果)</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#gpu">特性：支持训练过程中动态调整可用的GPU</a>
    </li>
        </ul>
    </li>
    </ul>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Awesome-tools</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>About</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="batch_runpy">并行调参脚本(batch_run.py)使用说明</h1>
<p><strong>原理</strong>: 通过组合命令行参数来执行不同的实验配置，需要把模型参数暴露为命令行参数。</p>
<p>该使用文档将分为输入的<a href="#配置文件config.json">配置文件</a>、输出的<a href="#运行日志(main_process.log)">运行日志</a>和<a href="#支持的子命令">支持的子命令</a>三个部分进行讲解</p>
<hr />
<h2 id="configjson">配置文件(config.json)</h2>
<pre><code class="json">{
  &quot;output_folder&quot;: &quot;/xx/tune_params/&quot;,
  &quot;available_gpus&quot;: [0, 1, 2],
  &quot;max_process_per_gpu&quot;: 2,
  &quot;device_arg_name&quot;: &quot;-device&quot;, // device参数的名称
  &quot;model_path_arg_name&quot;: &quot;-model-path&quot;, // 模型输出参数的名称
  &quot;base_cmd&quot;: &quot;python -m spannet.running.train&quot;,
  &quot;common_args&quot;: &quot;-data arn_data/ACE2005&quot;,
  &quot;cmd_option&quot;:
  {
    &quot;-arg1&quot;: {
       &quot;type&quot;: &quot;single&quot;,
       &quot;value&quot;: 1
      },
    &quot;-arg2&quot;: {
      &quot;type&quot;: &quot;null&quot;
    },
    &quot;-arg3&quot;:{
      &quot;type&quot;: &quot;enum&quot;,
      &quot;value&quot;: [&quot;x&quot;, &quot;xx&quot;, &quot;xxx&quot;]
    },
    &quot;-arg4&quot;: {
      &quot;type&quot;: &quot;arr&quot;,
      &quot;start_value&quot;: 1,
      &quot;stop_value&quot;: 2,
      &quot;step&quot;: 0.1
    }
  }
}
</code></pre>

<p>支持的参数类型包括4类：<strong><em>single、null、enum、arr</em></strong>，可根据实际情况选择</p>
<p>命令行参数根据是否需要在本脚本运行时才能确定，可分为静态参数和动态参数两个部分，其中，静态参数又分为(base_cmd)、不需进行搜索的超参(common_args)和需要进行搜索的超参(cmd_option)；动态参数目前暂时只有1个：动态地对当前可使用的gpu进行选择。</p>
<p>命令行指令: {静态参数: {base_cmd、common_args、cmd_option}, 动态参数}</p>
<p>模型的输出文件夹名仅由cmd_option确定</p>
<hr />
<h2 id="main_processlog">运行日志(main_process.log)</h2>
<ul>
<li>并行调试程序的进程编号</li>
<li>输出结果的文件夹</li>
<li>用于动态更新GPU的配置文件所在路径</li>
<li>本次训练模型总数</li>
<li>TO RUN CMD中为需执行的所有命令行</li>
<li>当前可使用的GPU列表</li>
<li>[CMD_ID]. 静态参数</li>
<li>[CMD_ID]. Run [PID]: ON GPU [GPU_ID] CMD, 正在执行的CMD编号、进程编号、GPU编号以及完整的命令行</li>
<li>[CMD_ID]. [PID] Run Err Code: [Err_Code] Used xx:xx:xx 代表该命令执行失败，报错退出，程序执行时间（返回的错误码可在被执行的程序，通过<code>exit(Err_Code)</code>，这样错误就能被捕获，方便重训练）</li>
<li>[CMD_ID]. [PID] Run Finished Code: 0 Used xx:xx:xx 代表该命令执行成功，正常结束</li>
<li>对本次批训练的总结，如果有命令执行失败的指令，则会返回这些指令的编号，可用于重训练</li>
</ul>
<pre><code class="text">MAIN_PROCESS_ID xxxx
OUTPUT FOLDER /xx/tune_params/
UPDATE GPU CONFIG PATH /xx/tune_params/config.json
TOTAL x MODELS TO BE TRAINED
TO RUN CMD
    1. python -m spannet.running.train -max-span-size 6 ann  -model-path /xx/0_maxspansize_6_ann_
    ...

00:00:00 AVAILABLE GPUS: [0, 1, 2]
00:00:00 x. Run xxxx: ON GPU x python -m spannet.running.train -max-span-size 6 ann  -model-path /xx/0_maxspansize_6_ann_
...
00:01:33 x. xxx Run Err Code: 137 Used xx:xx:xx
...
00:04:50 x. xxx Run Finished Code: 0 Used xx:xx:xx
...

00:12:44 FINISH ALL PROCESSES!
xx MODELS ARE TRAINED, xx MODELS END NORMALLY, xx MODELS EXITS ABNORMALLY
THESE CMD_IDS MAY NEED TO BE RETRAINED:
[5, 6, 7, 8, 9]

</code></pre>

<hr />
<h2 id="_1">支持的子命令</h2>
<p>该脚本支持4个子命令，分别为 <strong>get_cmds</strong>、<strong>train</strong>、<strong>kill</strong> 和 <strong>get_results</strong></p>
<pre><code class="text">python batch_run.py -h
usage: batch_run.py [-h] {get_cmds,train,kill,get_results} ...

positional arguments:
  {get_cmds,train,kill,get_results}
    get_cmds            list all cmds
    train               start batch train
    kill                stop all training model
    get_results         get all final results
</code></pre>

<h3 id="1-get_cmds">1. get_cmds子命令 (获取所有静态参数)</h3>
<p>按顺序给出配置文件支持的所有静态参数</p>
<p>包含一个参数：
-config_path 进行超参搜索的参数配置文件路径；必选</p>
<pre><code class="text">python batch_run.py get_cmds -h
usage: batch_run.py get_cmds [-h] -config_path CONFIG

optional arguments:
  -h, --help           show this help message and exit
  -config_path CONFIG  batch train's config path
</code></pre>

<pre><code class="text">0. python -m spannet.running.train -max-span-size 6 ann  -model-path /xx/0_maxspansize_6_ann_
1. python -m spannet.running.train -max-span-size 7 ann  -model-path /xx/1_maxspansize_7_ann_
2. python -m spannet.running.train -max-span-size 8 ann  -model-path /xx/2_maxspansize_8_ann_
3. python -m spannet.running.train -max-span-size 9 ann  -model-path /xx/3_maxspansize_9_ann_
4. python -m spannet.running.train -max-span-size 10 ann  -model-path /xx/4_maxspansize_10_ann_
</code></pre>

<hr />
<h3 id="2-train">2. train子命令（批训练、负载测试以及重训练）</h3>
<p>该子命令可以实现跟训练有关的3个功能：</p>
<p>1.<strong>批训练</strong>：初次批训练，通过读取给定的配置文件（json格式），进行超参的组合，统一把批训练得到的结果放在配置文件指定的目录(output_folder)下，如：tune_params目录下。</p>
<pre><code class="text">tune_params/
├── config.json 配置文件的拷贝
├── logs 每一个模型训练过程的log信息，每个log文件名的首序号即为模型序号
├── main_process.log 整个批训练过程的log，如当前哪些GPU可以使用，哪些模型已经训练好
└── models 批训练得到的每一个模型，每个model的文件夹名的首序号即为模型序号
</code></pre>

<p>2.<strong>负载测试</strong>：测试批训练中一个模型GPU负载（这里假设所有的批训练模型GPU使用不会有太大的变化），用来设置配置文件中的"max_process_per_gpu"信息。当模型载入GPU，稳定后，可通过子命令kill终止。 运行过程跟批训练一致，但只选第一个命令行执行。</p>
<p>3.<strong>重训练</strong>：在批训练后，对某些模型进行重新训练。在-config_path设置批训练生成的config.json的绝对路径（/xx/tune_params/config.json），并修改该配置文件，添加"cmd_ids"一项，把需要重新训练的模型的序号以列表给出即可。（如"cmd_ids": [2, 6, 8]）</p>
<p><strong><em>注意：该脚本会自动把需重训的对应模型文件夹删除，而原main_process.log文件会自动存档变为main_process_history_x.log</em></strong></p>
<p>包含三个参数：</p>
<p>-config_path 进行超参搜索的参数配置文件路径；必选</p>
<p>-load_test 二选一，当给出时，表示进行负载测试</p>
<p>-retrain 二选一，当给出时，表示进行重训练</p>
<pre><code class="text">python batch_run.py train -h
usage: batch_run.py train [-h] -config_path CONFIG [-load_test] [-retrain]

optional arguments:
  -h, --help           show this help message and exit
  -config_path CONFIG  batch train's config path
  -load_test           test how much memory a model consumes
  -retrain             retrain some models
</code></pre>

<hr />
<h3 id="3-kill">3. kill子命令 (终止批训练或负载测试)</h3>
<p>包含一个参数:</p>
<p>-output_folder 配置文件中的output_folder指出的路径（如/xx/tune_params）</p>
<pre><code class="text">python batch_run.py kill -h
usage: batch_run.py kill [-h] -output_folder CONFIG

optional arguments:
  -h, --help            show this help message and exit
  -output_folder CONFIG
</code></pre>

<p>另一个比较简单的终止训练的方法，打开批训练生成的main_process.log文件，获取主进程pid，在终端执行
<code>kill -9 -pid</code></p>
<hr />
<h3 id="4-get_results">4. get_results子命令 (获取所有训练结果)</h3>
<p>从logs下获取每个模型的输出结果
包含三个参数：</p>
<p>-output_folder 配置文件中的output_folder指出的路径（如/xx/tune_params）</p>
<p>-result_patten 每个模型的输出结果的正则表达式（如：<code>"Final Test  (Loss: .+?, P: .+?, R: .+?, F1: .+)"</code>）</p>
<p>-re_group_index 最终结果输出的组别</p>
<pre><code class="text">python batch_run.py get_results -h
usage: batch_run.py get_results [-h] -output_folder OUTPUT_FOLDER
                                -result_patten RES_PATTEN -re_group_index
                                RE_GROUP_INDEX

optional arguments:
  -h, --help            show this help message and exit
  -output_folder OUTPUT_FOLDER
  -result_patten RES_PATTEN
  -re_group_index RE_GROUP_INDEX
</code></pre>

<hr />
<h3 id="gpu">特性：支持训练过程中动态调整可用的GPU</h3>
<p><strong>1. 增加GPU</strong>.
若想增加可用GPU，只需增加配置文件中output_folder给出的路径下config.json里的available_gpus即可。（必须修改的是output_folder下的config.json，暂不支持修改max_process_per_gpu）</p>
<p><strong>2. 减少GPU</strong>.
若想禁用某一GPU，则只需在available_gpus中删去该gpu编号即可。
若想即刻禁用，则在config.json中加入"kill_at_once": true,
否则，会等待该GPU上的程序运行完毕为止</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href=".." class="btn btn-neutral" title="Home"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href=".." style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
